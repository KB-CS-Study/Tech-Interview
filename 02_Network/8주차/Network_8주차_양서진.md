# 로드 벨런싱

- AWS
    
    로드 밸런싱은 애플리케이션을 지원하는 리소스 풀 전체에 네트워크 트래픽을 균등하게 배포하는 방법입니다. 최신 애플리케이션은 수백만 명의 사용자를 동시에 처리하고 정확한 텍스트, 비디오, 이미지 및 기타 데이터를 빠르고 안정적인 방식으로 각 사용자에게 반환해야 합니다. 이렇게 많은 양의 트래픽을 처리하기 위해 대부분의 애플리케이션에는 데이터가 중복되는 리소스 서버가 많이 있습니다. 로드 밸런서는 사용자와 서버 그룹 사이에 위치하며 보이지 않는 촉진자 역할을 하여 모든 리소스 서버가 동일하게 사용되도록 하는 디바이스입니다.
    

## 로드 벨런서란 ? + L4 vs L7

**로드밸런싱(Load Balancing) 란?**

: 두개 이상의 컴퓨터 자원에 작업을 나누는 것을 의미.

**로드밸런서(Load Balancer)란?**

: 클라이언트와 Server 그룹 사이에서 위치하여 서버의 부하를 분산시켜주는 하드웨어/소프트웨어 를 의미한다.

**로드밸런서의 역할**

- 네트워크 트래픽 또는 클라이언트 요청을 여러 서버에 적절하게 분배한다. (특정 서버의 부하를 덜어줌)
- Active 한 서버에만 요청을 전송한다. (서버가 다운되면 리다이렉션 > 높은 가용성과 신뢰성을 보장해줌)
- 서비스 중단 없이 서버를 추가하거나 뺄 수 있게 해준다. (유연성 제공)

### 로드벨런서의 주요기능

로드벨런서는 3가지의 주요 기능을 통해 로드벨런싱을 진행한다.

Network Address Translation ( NAT )

사설 주소인 Private IP를 공인 IP 주소 (Public IP) 로 바꾸는데 사용하는 통신망의 주소 변조기이다.

Tunneling

데이터를 캡슐화하여 연결된 노드만 캡슐을 해제할 수 있게 만듬

Dynamic Source Routing protocol (DSR)

요청에 대한 응답을 할 때 로드벨런서가 아닌 클라이언트의 IP로 응답


<img width="539" alt="image" src="https://github.com/user-attachments/assets/b7751f12-0c60-410e-82b1-e3cda4e43362" />


하위 계층으로 갈수록 간단한 부하 분산이 가능, 가격이 비싸짐

상위 계층으로 갈수록 가격이 비쌌지만 현재 점점 가격 차이가 줄어드는 추세이기에 L7을 주로 사용한다.

![image2](https://github.com/user-attachments/assets/e28e59ab-e8af-4ca5-af8f-1c097f159cb9)


L4 Load Balancer 는 IP, Port 를 기준으로 스케줄링 알고리즘을 통해 부하를 분산한다.

클라이언트에서 로드벨런서(DNS)로 요청을 보냈을때 최적의 서버로 요청을 전송하고 결과를 클라이언트에게 준다.

한대의 서버에 각기 다른 포트 번호를 부여해서 다수의 서버 프로그램을 운영하는 경우라면 최소한 L4 로드 벨런서 이상을 사용해야 한다.

L7 Load Balancer는 L7 위에서 동작하기 때문에 IP, Port 이외에도 **URL,** Payload, Http Header, Cookie 등의 내용을 기준으로 부하를 분산한다. 패킷의 내용을 확인해서 그 내용에 따라 트래픽을 특정 서버에 전송하는 것이 가능한 것이다. URL 에 따라서 부하를 분산시키거나, HTTP 헤더의 쿠키 값에 따라서 부하를 분산하는 등 클라이언트의 요청을 보다 세분화해 서버에 전달할 수 있다.

그리고 서버의 응답까지 알고 분석할 수 있기 때문에 서버들로부터 필요한 정보를 응답 받아 클라이언트의 요청을 전달하기 전에 서버의 상태를 파악한 후 로드벨런싱을 진행할 수 있다.

또한 L7 Load Balancer는 L4 Load Balancer와 다르게 **데이터를 분석해서 처리가 가능하기 때문에 악의적이거나 비전상적인 콘텐츠를 감지해 보안 지점을 구축할 수 있는 장점이 있고, 그만큼 자원소모가 크다는 단점**이 있다.

## 로드 벨런서 알고리즘 종류

**1. 라운드 로빈 (Round Robin)**

순차적으로 돌아가며 세션을 할당해주는 방식입니다.

요청이 오면 단순히 그 요청을 순서대로 서버에 분배해주는데 첫 번째 요청은 첫 번째 서버, 두 번째 요청은 두 번째 서버에 할당해 줍니다. 로드밸런싱 대상 서버의 스펙이 동일하고, 처리 시간 혹은 세션지속시간이 짧은 애플리케이션의 경우 이러한 방식이 적합합니다.

**2. 가중 라운드 로빈 (Weighted Round Robin)**

각 서버마다 가중치를 설정해두고 해당 가중치만큼 세션을 할당해주는 방식입니다. 특정 서버의 스펙이 좋다면 해당 서버에 가중치를 좀 더 주어 세션을 더 많이 할당해주고, 스펙이 좋지 않은 서버에는 가중치를 적게 두어 세션을 적게 할당해주는 방식입니다.

**3. 최소 연결 (Least Connection)**

가장 적게 연결(가장 적은 세션)되어 있는 서버에 세션을 할당해주는 방식입니다.

서버에 분배된 세션들이 일정하지 않은 경우에 적합하며 부하를 줄이는 측면에서 많이 사용됩니다.

**4. 최소 응답 (Least Response Time)**

서버의 응답시간을 고려하여 세션을 할당해주는 방식입니다. 가장 짧은 응답 시간을 보이는 서버에 우선적으로 세션을 할당해주는 방식입니다.

**5. 해시 (Hash)**

특정 사용자는 특정 서버로만 할당시키는 방식입니다. 특정 IP주소나 포트를 갖는 사용자들은 특정 서버로만 세션을 맺도록 하는데 특정 IP주소나 포트에서 접속량이 특히 많을 때 관리가 편한 방식입니다.

## 헬스 체크 + 장애 조치

헬스 체크 

상태는 일정한 주기로 서버의 특정 경로( / )에 요청(HTTP)을 보냈을 때 응답 코드(200)로 판단을 합니다.

헬스 체크 경로는 가급적 많은 데이터 트래픽을 발생시키지 않은 곳이 적당하고, 요청 주기, 재시도 횟수, 프로토콜 등도 필요에 따라 설정할 수 있습니다.

장애 조치

장애 조치는 시스템의 일부에 장애가 발생했을 때, 자동으로 다른 정상적인 시스템이나 서버로 트래픽이나 작업을 전환하는 과정입니다. 이를 통해 서비스의 지속성을 유지하고 사용자에게 최소한의 영향만을 주도록 합니다.

### 복구(Recovery)란?

복구는 장애가 발생한 시스템이나 서비스가 정상 상태로 돌아오도록 복구 작업을 수행하는 것을 말합니다. 이는 장애 원인을 해결하고, 시스템을 다시 안정적으로 운영할 수 있도록 하는 과정입니다.

### Why important?

- 가용성 향상 : 시스템이 항상 작동 상태를 유지하도록 도와줍니다.
- 신뢰성 증대 ; 사용자에게 안정적인 서비스를 제공하여 신뢰를 얻을 수 있습니다.
- 비용 절감 : 장애로 인한 다운타임을 최소화하여 비즈니스 손실을 줄일 수 있습니다.

## DNS로 하는 로드벨런싱

![image3](https://github.com/user-attachments/assets/8c8606b3-d0e7-4061-9b4d-df5e165fcf81)

별도의 SW, HW 로드벨런싱 장비를 이용하지 않고 DNS를 이용하여 도메인 정보를 조회하는 시점에서 다른 IP 정보를 통해 트래픽을 분산하는 기법.

DNS 부하 분산은 애플리케이션 계층 7의 DNS 수준에서 작동하며 TCP/IP 모델의 전송 계층에서 UDP(사용자 데이터그램 프로토콜)를 사용하여 데이터를 전송합니다. 하지만 UDP는 속도와 가벼운 패킷으로 인해 DNS의 경우 TCP보다 선호됩니다. 

# 웹 서버 & WAS 관련

## 정적 vs 동적 페이지 차이

## 정적 웹 페이지 (Static Web Page)

- 웹 서버에 **이미 저장된 파일**(HTML 파일, 이미지, JavaScript 파일 등)**을 클라이언트에게 전송하는 웹 페이지**다.
- 사용자는 서버에 저장된 데이터가 변경되지 않는 한 고정된 웹 페이지를 계속 보게 된다.
- 따라서 모든 사용자는 같은 결과의 웹 페이지를 서버에 요청하고 응답 받게 된다.

> 장점다른 처리 없이 요청에 대한 파일만 전송하기 때문에 빠르다.단순한 문서로 웹 서버를 구축하므로 호스팅 서버에 연결하는 비용이 적다.
> 
> - 단점
>     - 저장된 정보만 보여주기 때문에 서비스가 한정적이다.
>     - 추가, 삭제, 수정 등의 작업이 모두 코드를 직접 건드려야 하기 때문에 관리가 힘들다.

---

## 동적 웹 페이지 (Dynamic Web Page)

- 서버에 저장된 HTML 파일이 그대로 브라우저에 나오는 것이 아닌, **동적으로 만들어지는 웹 페이지**
- 요청에 관하여 사용자는 조건에 따라 다른 결과를 받게 된다.
- 사용자는 상황, 시간, 요청 등에 따라 달라지는 웹 페이지를 보게 된다.

### [ 동적 웹 페이지의 종류 ]

### 1. CSR (Client Side Rendering)

![](https://images.velog.io/images/dyunge_100/post/39c4d37a-7ad5-4ac6-b8bd-0cd17f0c4e21/image.png)

![](https://images.velog.io/images/dyunge_100/post/c373ff99-acf8-47d4-838a-a042fde0a54e/image.png)

- CSR은 데이터가 없는 HTML 문서나 Static 파일만을 처음에 받아와 로드하고, 이후에 데이터를 요청하여 받아오는 방식이다.
- 자바스크립트를 사용하여 브라우저에서 페이지를 직접 렌더링을 진행한다.
- **모든 로직, 데이터 가져오기, 템플릿 및 라우팅 등은 서버가 아닌 클라이언트 측에서 처리한다.**
    
    ### 2. SSR (Server Side Rendering)
    

![](https://images.velog.io/images/dyunge_100/post/1c2d2db8-14dd-4846-b531-84dad4635ef8/image.png)

- **CSR과 상반되게 서버에서 동적으로 데이터까지 전부 삽입하여 완성된 HTML을 넘겨준다.**
- 서버 렌더링은 브라우저에서 응답을 받기 전에 처리되므로 클라이언트에서 데이터를 가져오거나 템플릿 작성에 대한 추가 왕복이 발생하지 않는다. (어쨌든 웹 서버에서 모든 요청이 처리된다.)

### 3. MPA (Multi Page Application)

- **새로운 페이지를 요청할 때마다 정적 리소스가 다운로드 되고, 그에 맞춰 전체 페이지를 다시 렌더링하는 방식이다.** (즉, SSR 방식으로 렌더링한다.)
- 인터넷 주소창에 주소를 입력하거나 링크를 클릭하는 등의 사용자가 어떠한 요청을 하게 되면, 그에 맞는 완전한 페이지를 받아오고 다시 렌더링된다.
- 장점은 검색 엔진 최적화(SEO, Search Engine Optimization) 관점에서는 유리하지만, 단점으로는 새로운 페이지를 이동할 때마다 완전히 새로 렌더링 되므로 깜빡거리고 프론트엔드와 백엔드가 밀접하게 연결되어 개발이 복잡할 수 있다.

### 4. SPA (Single Page Application)

![](https://images.velog.io/images/dyunge_100/post/84616e18-d175-47d5-b73b-734fbc2e1922/image.png)

- 웹 애플리케이션에 필요한 **모든 정적 리소스를 최초 한 번만 다운로드**를 한다.그 이후, 새로운 페이지에 대한 요청이 있을 때마다 페이지 갱신에 **필요한 데이터만 전달 받고 그 정보를 기준으로 페이지를 갱신**한다. (즉, CSR 방식으로 렌더링한다.)
- SPA를 만드는데 사용되는 프레임워크로 **React, Bue, Angular**가 있다.
- 장점으로는 최초 접속 시 맨 첫 페이지 로딩 시간을 길어도 이후 페이지부터는 속도가 빠르다. 또한 앞선 MPA와 달리 **깜빡거림이 없고 반응 속도가 좋다.** 또한 **로컬 데이터를 효과적으로 캐싱**할 수도 있다. 단점으로는 초기 구동 속도가 느리고 SEO에 불리하다는 것이다.

## 웹 서버와 WAS의 역할 비교

![image4](https://github.com/user-attachments/assets/c5ec74b2-56d4-41b4-8a88-983f3b347b6c)


### 웹 서버와 WAS 서버 비교

| 항목 | 웹 서버 | WAS 서버 |
| --- | --- | --- |
| 정의 | 정적인 콘텐츠(HTML, CSS, 이미지 등)를 제공하는 서버 | 동적인 콘텐츠(웹 애플리케이션)를 처리하고 제공하는 서버 |
| 기능 | HTTP 프로토콜을 이용해 클라이언트에게 웹 페이지 제공 | 웹 애플리케이션 실행 및 데이터 처리, 웹 서버와 클라이언트 간의 중계 역할 |
| 주요 소프트웨어 | Apache, Nginx, IIS | Tomcat, JBoss, WebLogic, WebSphere |

### ✅ 웹 서버의 역할과 예시

웹 서버는 클라이언트가 웹 브라우저를 통해 요청한 정적 콘텐츠를 제공하는 역할을 합니다. 웹 서버는 주로 HTTP 프로토콜을 사용하여 작동하며, 클라이언트가 URL을 통해 요청한 웹 페이지를 찾아 전송해줍니다.

> 예시: 회사 홈페이지, 블로그, 뉴스 사이트 등
> 

### ✅ WAS 서버의 역할과 예시

WAS 서버는 웹 애플리케이션을 실행하여 동적 콘텐츠를 생성하고, 웹 서버와 클라이언트 간의 데이터 처리를 담당하는 역할을 합니다. WAS 서버는 클라이언트의 요청에 따라 데이터베이스에서 정보를 가져오거나, 웹 애플리케이션을 실행하여 동적인 웹 페이지를 생성한 후 결과를 웹 서버에 전달합니다. 웹 서버는 이를 받아 클라이언트에게 전달합니다.

> 예시: 온라인 쇼핑몰, 은행 인터넷 뱅킹, SNS 등
> 

## 웹 서버와 ↔ WAS 협업 구조(리버스 프록시 포함)

실제 웹 서비스 환경에서는 웹 서버와 WAS 서버가 협업하여 작동합니다. 일반적으로 웹 서버는 정적 콘텐츠를 처리하고 WAS 서버는 동적 콘텐츠를 처리하는 역할을 맡아, 사용자에게 원활하고 다양한 웹 서비스를 제공하게 됩니다. 이를 통해 웹 사이트의 로딩 속도와 서비스 품질이 향상되며, 웹 애플리케이션의 성능이 개선됩니다.

### 🔍 웹 서버와 WAS 서버의 활용 사례

> 실제 웹 서비스에서는 웹 서버와 WAS 서버가 함께 사용되는 경우가 많습니다. 대표적인 활용 사례로는 다음과 같은 것들이 있습니다.
> 
- **온라인 쇼핑몰** : 사용자가 상품을 검색하거나 장바구니에 담는 등의 동적인 작업을 WAS 서버에서 처리하고, 상품 이미지나 스타일 정보 등 정적 콘텐츠를 웹 서버에서 제공합니다.
- **온라인 커뮤니티** : 게시판 글 작성, 댓글 달기 등 동적인 기능은 WAS 서버에서 처리하고, 게시글 내용이나 이미지 등 정적 콘텐츠는 웹 서버에서 제공합니다.

---

웹 서버와 WAS 서버는 각각 정적 콘텐츠와 동적 콘텐츠를 처리하는 역할을 담당하며, 실제 웹 서비스 환경에서는 서로 협업하여 사용자에게 원활한 웹 서비스를 제공합니다. 이를 통해 웹 서비스의 성능과 품질을 최적화할 수 있습니다.

### **책임 분배를 통한 서버 부하 방지**

정적 페이지를 웹 서버가 제공해주고 동적 페이지를 WAS가 제공해주면 책임 분배에 따른 성능 이점을 누릴 수 있습니다. 만약 WAS가 동적 페이지, 정적 페이지 제공을 모두 수행한다면 지연 시간이 길어질 것이며 페이지 노출 시간이 길어지게 됩니다.

### **여러 대의 WAS 연결 가능**

하나의 웹 서버에 여러 대의 WAS가 연결될 수 있습니다. 그리고 이런 경우, 웹서버가 로드밸런싱의 역할까지 담당할 수 있습니다. 또한 WAS에 대한 헬스체킹 기능까지 수행해서 어떤 서버가 요청에 대한 불능 상태인지를 쉽게 파악할 수 있습니다. 무중단 서버 운영을 위한 장애 극복에도 쉽게 대응할 수 있게 됩니다.

### **보안 관련**

웹서버를 따로 두게되면 보안상 이점을 가질 수 있습니다. 실제 서버가 외부에 노출되지 않기 때문입니다. 몇 대의 WAS가 존재하든 상관없이, 사용자는 진입점이 모두 웹서버로 동일해집니다. 그리고 이 요청이 어떻게 분산되어 어느 WAS에 도달하는지는 이제 웹 서버의 책임인거죠.

이런 특성으로 인해 웹서버 + WAS 구조를 사용하면 HTTPS 서버도 쉽게 구축이 가능합니다. SSL 인증서를 받은 뒤, 단순히 리버스 프록시 기능을 활용해 요청을 WAS로 전달할 수 있습니다. 즉, 클라이언트 입장에서는 HTTPS 프로토콜을 사용해 WAS에 접근하는 것처럼 보이지만, 실제로는 HTTPS 연결은 웹 서버와 이루어지며 내부적으로 HTTP 프로토콜을 통해 WAS에 접근하게 됩니다.

## 웹/WAS를 왜 분리해서 쓰는가?

![image5](https://github.com/user-attachments/assets/0c42086f-40d7-4019-a75e-18ce2522882c)


책임을 분배함으로서 더욱 유지보수하기 좋은 서비스를 만들고, 심지어 보안 성능 이슈까지 대응할 수 있다.
